{% extends "core/base.html" %}
{% load money_filters %}
{% load stripe_filters %}
{% block content %}
<h2 class="mb-3">Bookings</h2>

<form method="get" class="row g-2 mb-3" id="bookingFilters">
  <div class="col-auto">
    <select name="range" id="rangeSelect" class="form-select">
      {% for val,label in presets %}
        <option value="{{ val }}" {% if val == range_label %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-auto" id="customDates" style="display: {% if range_label == 'custom' %}block{% else %}none{% endif %}">
    <div class="input-group">
      <span class="input-group-text">Start</span>
      <input class="form-control" type="date" name="start" value="{{ start_q }}">
      <span class="input-group-text">End</span>
      <input class="form-control" type="date" name="end" value="{{ end_q }}">
    </div>
  </div>
  <div class="col-auto">
    <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Search client/service/location/notes">
  </div>
  <div class="col-auto">
    <button class="btn btn-primary">Apply</button>
    <a class="btn btn-outline-secondary" href="{% url 'booking_list' %}">Reset</a>
  </div>
  <div class="col-auto ms-auto">
    <a class="btn btn-outline-success"
       title="Export all bookings in current range to iCalendar"
       href="{% url 'booking_export_ics' %}?range={{ range_label }}&start={{ start_q }}&end={{ end_q }}">Export all (.ics)</a>
    <a class="btn btn-outline-success"
       href="{% url 'booking_export_ics' %}?range={{ range_label }}&start={{ start_q }}&end={{ end_q }}&alarm=1"
       title="Export with a 5-minute reminder alarm">Export all (.ics + alarm)</a>
    <button type="submit" formaction="{% url 'booking_export_ics' %}" formmethod="get" class="btn btn-success"
            onclick="this.form.ids.value = Array.from(document.querySelectorAll('.rowcheck:checked')).map(cb=>cb.value).join(',');">
      Export selected (.ics)
    </button>
    <input type="hidden" name="ids" value="">
  </div>
</form>

{% if messages %}
  {% for m in messages %}<div class="alert alert-info py-1">{{ m }}</div>{% endfor %}
{% endif %}

<div class="table-responsive">
<table class="table table-hover align-middle">
  <thead class="table-light">
    <tr>
      <th scope="col" aria-label="Select"><input type="checkbox" id="checkall" onclick="document.querySelectorAll('.rowcheck').forEach(cb=>cb.checked=this.checked)"></th>
      <th scope="col">Date</th>
      <th scope="col">Start</th>
      <th scope="col">End</th>
      <th scope="col">Client</th>
      <th scope="col">Service</th>
      <th scope="col">Location</th>
      <th scope="col">Dogs</th>
      <th scope="col">Status</th>
      <th scope="col" class="text-end">Price (AUD)</th>
      <th scope="col" class="text-end">Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for b in bookings %}
      <tr>
        <td><input type="checkbox" class="rowcheck" value="{{ b.id }}"></td>
        <td>{{ b.start_dt|date:"Y-m-d (D)" }}</td>
        <td>{{ b.start_dt|date:"H:i" }}</td>
        <td>{{ b.end_dt|date:"H:i" }}</td>
        <td>{{ b.client.name }}</td>
        <td>{{ b.service_label|default:b.service_name|default:b.service_code }}</td>
        <td>{{ b.location }}</td>
        <td>{{ b.dogs }}</td>
        <td>{{ b.status }}</td>
        <td class="text-end">{{ b.price_cents|cents_to_dollars }}</td>
        <td class="text-end">
          {% if b.stripe_invoice_id %}
            <a class="btn btn-sm btn-outline-primary"
               href="{% url 'booking_open_invoice' b.id %}?range={{ range_label }}">Open invoice</a>
          {% elif b.payment_intent_id %}
            <a class="btn btn-sm btn-outline-dark"
               href="{{ b.payment_intent_id|stripe_payment_url }}"
               target="_blank" rel="noopener"
               title="View payment in Stripe Dashboard">Open in Stripe</a>
          {% else %}
            <span class="text-muted small">No invoice/payment</span>
          {% endif %}
          <a class="btn btn-sm btn-outline-danger"
             href="{% url 'booking_soft_delete' b.id %}?range={{ range_label }}"
             onclick="return confirm('Delete this booking?');">Delete</a>
        </td>
      </tr>
    {% empty %}
      <tr><td colspan="11" class="text-muted">No bookings for this range.</td></tr>
    {% endfor %}
  </tbody>
</table>
</div>

<script>
  // Toggle custom start/end when "Custom range" is selected
  document.getElementById('rangeSelect')?.addEventListener('change', function(){
    const show = this.value === 'custom';
    document.getElementById('customDates').style.display = show ? 'block' : 'none';
  });
</script>
{% endblock %}