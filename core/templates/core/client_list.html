{% extends "core/base.html" %}
{% load money_filters %}
{% block content %}
<h2 class="mb-3">Clients</h2>

<form method="post" action="{% url 'clients_stripe_sync' %}" class="mb-3" data-disable-on-submit>
  {% csrf_token %}
  <button class="btn btn-outline-primary" title="Link clients to Stripe by email">Sync Stripe customers</button>
  <span class="text-muted ms-2 small">Links by email; updates phone/address; respects test/live key.</span>
</form>

<div class="table-responsive">
<table class="table table-hover align-middle">
  <thead class="table-light">
    <tr>
      <th scope="col">Name</th>
      <th scope="col">Credit (AUD)</th>
      <th scope="col">Email</th>
      <th scope="col">Phone</th>
      <th scope="col">Address</th>
      <th scope="col">Stripe</th>
      <th scope="col">Tags</th>
      <th scope="col" class="text-end">Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for c in clients %}
      <tr>
        <td>{{ c.name }}</td>
        <td>{{ c.credit_cents|cents_to_dollars }}</td>
        <td>{{ c.email|default:"—" }}</td>
        <td>{{ c.phone|default:"—" }}</td>
        <td class="small">{{ c.address|default:"—" }}</td>
        <td>
          {% if c.stripe_customer_id %}
            <code>{{ c.stripe_customer_id }}</code>
          {% else %}<span class="text-muted">—</span>{% endif %}
        </td>
        <td>
          {% with ts=c.tags.all %}
            {% if ts %}
              {% for t in ts|slice:":3" %}
                <span class="badge bg-secondary" {% if t.color %}style="background: {{ t.color }}"{% endif %}>{{ t.name }}</span>
              {% endfor %}
              {% if ts|length > 3 %}
                <span class="text-muted small">(+{{ ts|length|add:"-3" }})</span>
              {% endif %}
            {% else %}—{% endif %}
          {% endwith %}
        </td>
        <td class="text-end">
          <div class="btn-group">
            <a class="btn btn-sm btn-outline-primary" href="{% url 'client_stripe_open' c.id %}">Open in Stripe</a>
            <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#linkModal{{ c.id }}">Link…</button>
            <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#creditModal{{ c.id }}">Add credit</button>
          </div>
          <!-- Link modal -->
          <div class="modal fade" id="linkModal{{ c.id }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
              <form method="post" action="{% url 'client_stripe_link' c.id %}" class="modal-content">
                {% csrf_token %}
                <div class="modal-header">
                  <h5 class="modal-title">Link to Stripe ({{ c.name }})</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <label class="form-label">Stripe Customer ID (cus_…) or Email</label>
                  <input class="form-control" name="stripe_id_or_email" placeholder="cus_xxx or name@example.com">
                  <p class="small text-muted mt-2">If you enter an email, we will search/create a Stripe customer and link it.</p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button class="btn btn-primary">Link</button>
                </div>
              </form>
            </div>
          </div>
          <!-- Credit modal -->
          <div class="modal fade" id="creditModal{{ c.id }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
              <form method="post" action="{% url 'client_credit_add' c.id %}" class="modal-content" data-disable-on-submit>
                {% csrf_token %}
                <div class="modal-header">
                  <h5 class="modal-title">Add credit ({{ c.name }})</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <label class="form-label" for="amt{{ c.id }}">Amount</label>
                  <input id="amt{{ c.id }}" class="form-control" name="amount" placeholder="e.g. 2500 (cents) or 25.00 (dollars)" aria-describedby="amtHelp{{ c.id }}">
                  <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="neg{{ c.id }}" name="allow_negative" value="1">
                    <label class="form-check-label" for="neg{{ c.id }}">Allow negative adjustment (reduce credit)</label>
                  </div>
                  <p id="amtHelp{{ c.id }}" class="small text-muted mt-2">Stored in cents; UI shows dollars. Example: 2500 = $25.00. Use negative to reduce or correct balance.</p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button class="btn btn-success">Save</button>
                </div>
              </form>
            </div>
          </div>
        </td>
      </tr>
    {% empty %}
      <tr><td colspan="8" class="text-muted">No clients.</td></tr>
    {% endfor %}
  </tbody>
</table>
</div>
{% endblock %}