{% extends "core/base.html" %}
{% block content %}
<h2 class="mb-3">Stripe Status</h2>

{% if messages %}
  {% for m in messages %}<div class="alert alert-info py-1">{{ m }}</div>{% endfor %}
{% endif %}

<div class="card p-3 mb-3">
  <div class="d-flex flex-wrap align-items-center gap-3">
    <div>
      <div class="text-muted small">Key storage</div>
      <div><strong>{{ key_status.mode|default:"—" }}</strong></div>
    </div>
    <div>
      <div class="text-muted small">Configured</div>
      <div><strong>{% if key_status.configured %}Yes{% else %}No{% endif %}</strong></div>
    </div>
    <div>
      <div class="text-muted small">Environment</div>
      <div><strong>{{ key_status.test_or_live|default:"—" }}</strong></div>
    </div>
    <div class="ms-auto">
      {% if request.user.is_staff %}
        <form method="post" action="{% url 'stripe_key_update' %}" class="d-flex gap-2" data-disable-on-submit>
          {% csrf_token %}
          <label for="stripeKey" class="visually-hidden">Stripe Secret Key</label>
          <input id="stripeKey" type="password" name="stripe_api_key" class="form-control" placeholder="sk_test_... or sk_live_..." style="min-width: 320px;" aria-label="Stripe secret key">
          <button class="btn btn-primary" title="Save Stripe key">Change Stripe Key</button>
        </form>
      {% else %}
        <div class="text-muted small">
          Only staff can change the Stripe key. If you need to update it, contact a staff user.
        </div>
      {% endif %}
    </div>
  </div>
</div>

<div class="d-flex align-items-center gap-2 mb-3">
  <a class="btn btn-outline-primary" href="{% url 'stripe_status' %}?refresh=1" data-show-spinner>Refresh catalog</a>
  <span class="text-muted">Active prices in catalog: <strong>{{ catalog_count }}</strong></span>
  {% if catalog_preview %}
    <span class="ms-2 text-muted">(showing first {{ catalog_preview|length }})</span>
  {% endif %}
</div>

{% if catalog_preview %}
<div class="table-responsive">
  <table class="table table-sm table-hover align-middle">
    <thead><tr>
      <th>Display</th><th>Service code</th><th>Amount (cents)</th><th>Price ID</th><th>Product ID</th>
    </tr></thead>
    <tbody>
      {% for s in catalog_preview %}
      <tr>
        <td>{{ s.display_name }}</td>
        <td><code>{{ s.service_code }}</code></td>
        <td>{% if s.amount_cents %}{{ s.amount_cents }}{% else %}—{% endif %}</td>
        <td><code>{{ s.price_id }}</code></td>
        <td><code>{{ s.product_id }}</code></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}
{% endblock %}