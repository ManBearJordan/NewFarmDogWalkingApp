# Stripe Webhook Implementation

## Overview

This document describes the Stripe webhook implementation for handling invoice and subscription events in the New Farm Dog Walking application.

## Configuration

### Environment Variables

Add to your `.env` file:

```bash
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret_here
```

- **Optional**: If not set, webhooks will accept JSON without signature verification (development mode only)
- **Production**: Always set this value for security

### Webhook Endpoint

The webhook endpoint is available at:

```
POST /stripe/webhooks/
```

Configure this URL in your Stripe dashboard under Webhooks.

## Event Handling

### Invoice Events

The webhook handles the following invoice events:

- `invoice.finalized` - Invoice has been finalized
- `invoice.paid` - Invoice payment succeeded
- `invoice.payment_failed` - Invoice payment failed

**What happens:**
1. The invoice is processed via `process_invoice()` function
2. Line items are linked to bookings via metadata (`booking_id`, `service_code`, `booking_start`)
3. Booking fields are updated: `stripe_invoice_id`, `stripe_invoice_status`, `invoice_pdf_url`, `paid_at`
4. Invoice validation runs to flag any inconsistencies for admin review

### Subscription Events

The webhook handles the following subscription events:

- `customer.subscription.updated` - Subscription was updated
- `customer.subscription.deleted` - Subscription was deleted/canceled

**What happens:**

#### On Deletion or Cancellation
1. The local `StripeSubscriptionLink.active` is set to `False`
2. Future autogenerated bookings are removed
3. Schedule remains in database for historical reference

#### On Update
1. The schedule is re-materialized to reflect any admin changes
2. New bookings are created based on the current schedule
3. Existing manual bookings are preserved

### Unhandled Events

Any event type not explicitly handled (e.g., `charge.succeeded`, `customer.created`) will:
- Log a debug message
- Return 200 OK (Stripe best practice)

## Error Handling

The webhook implementation follows these principles:

1. **Never returns 5xx errors** - Always returns 200 to acknowledge receipt
2. **Signature verification failures** - Return 403 Forbidden
3. **Invalid JSON** - Return 400 Bad Request
4. **Processing errors** - Logged but don't fail the webhook (poller handles recovery)

## Security

### Signature Verification

When `STRIPE_WEBHOOK_SECRET` is configured:
- All webhook requests are verified using `stripe.Webhook.construct_event()`
- Invalid or missing signatures return 403 Forbidden
- Protects against replay attacks and unauthorized requests

### Development Mode

When `STRIPE_WEBHOOK_SECRET` is NOT configured:
- Webhooks accept valid JSON without signature verification
- Useful for local development and testing
- **DO NOT use in production**

## Testing

### Unit Tests

Run the webhook tests:

```bash
pytest core/tests/test_webhook_signature_verification.py -v
```

### Manual Testing

Use Stripe CLI to test webhooks locally:

```bash
# Install Stripe CLI
# https://stripe.com/docs/stripe-cli

# Forward webhooks to local server
stripe listen --forward-to http://localhost:8000/stripe/webhooks/

# Trigger test events
stripe trigger invoice.paid
stripe trigger customer.subscription.updated
```

### Test with cURL

```bash
# Without signature (development mode)
curl -X POST http://localhost:8000/stripe/webhooks/ \
  -H "Content-Type: application/json" \
  -d '{"type":"invoice.finalized","data":{"object":{"id":"in_test","customer":"cus_123","lines":{"data":[]}}}}'
```

## Integration with Polling

The webhook implementation works alongside the existing invoice polling system:

- **Webhooks**: Immediate updates for real-time responsiveness
- **Polling**: Safety net that catches any missed events
- **Both are active**: Webhooks provide speed, polling provides reliability

## Troubleshooting

### Webhook returns 403

- Check that `STRIPE_WEBHOOK_SECRET` matches your Stripe webhook configuration
- Verify the signature header is being sent correctly

### Bookings not updating

- Check logs for processing errors
- Verify invoice metadata includes required fields (`booking_id`, `service_code`, `booking_start`)
- Ensure the booking exists in the database

### Schedule not materializing

- Check that `StripeSubscriptionSchedule` exists for the subscription
- Verify the schedule has all required fields (`days`, `start_time`, `location`, `repeats`)
- Check that the service exists and has `duration_minutes` set

## Code Structure

### Files Modified

1. `newfarm/settings.py` - Added `STRIPE_WEBHOOK_SECRET` configuration
2. `core/stripe_invoices_sync.py` - Added `process_invoice()` function
3. `core/views_webhooks.py` - Complete rewrite with signature verification and event handling
4. `core/urls.py` - Webhook endpoint already configured (no changes)

### Key Functions

- `process_invoice(inv)` - Process a single invoice from webhook
- `materialize_for_schedule(sched)` - Update bookings for a subscription schedule
- `stripe_webhook(request)` - Main webhook handler view

## Logging

The webhook implementation logs at various levels:

- **INFO**: Successful event processing
- **WARNING**: Signature verification failures
- **ERROR**: Processing errors (with full traceback)
- **DEBUG**: Unhandled event types

Check application logs for webhook activity:

```bash
# Example log entries
INFO: Webhook invoice.paid processed invoice in_123: {'linked': 1, 'updated': 1}
INFO: Webhook customer.subscription.deleted: deactivated link 42; res={'removed': 5}
DEBUG: Unhandled Stripe event type: charge.succeeded
```

## Best Practices

1. **Always set STRIPE_WEBHOOK_SECRET in production**
2. **Monitor webhook logs** for processing errors
3. **Keep polling active** as a backup mechanism
4. **Test thoroughly** before deploying to production
5. **Use Stripe CLI** for local development and testing

## Support

For issues or questions:
- Check application logs for error details
- Review Stripe dashboard for webhook delivery attempts
- Verify webhook configuration matches Stripe settings
